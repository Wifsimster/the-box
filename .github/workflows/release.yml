name: Release

on:
    workflow_dispatch:
        inputs:
            version_type:
                description: "Version bump type"
                required: true
                type: choice
                options:
                    - patch
                    - minor
                    - major
                default: "patch"

permissions:
    contents: write
    packages: write

jobs:
    release:
        name: Create Release & Publish Docker Image
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Install dependencies
              run: npm ci

            - name: Bump version
              id: version
              run: |
                  npm run version:${{ inputs.version_type }}
                  NEW_VERSION=$(node -p "require('./package.json').version")
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "New version: $NEW_VERSION"

            - name: Generate changelog
              id: changelog
              run: |
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [ -z "$PREVIOUS_TAG" ]; then
                    echo "## What's Changed" > CHANGELOG_TEMP.md
                    echo "" >> CHANGELOG_TEMP.md
                    git log --pretty=format:"- %s (%h)" >> CHANGELOG_TEMP.md
                  else
                    echo "## What's Changed" > CHANGELOG_TEMP.md
                    echo "" >> CHANGELOG_TEMP.md
                    git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> CHANGELOG_TEMP.md
                  fi

                  # Parse conventional commits
                  echo "" >> CHANGELOG_TEMP.md
                  echo "### Features" >> CHANGELOG_TEMP.md
                  git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges | grep "^feat" | sed 's/^feat/- /' >> CHANGELOG_TEMP.md || echo "No new features" >> CHANGELOG_TEMP.md
                  echo "" >> CHANGELOG_TEMP.md
                  echo "### Bug Fixes" >> CHANGELOG_TEMP.md
                  git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges | grep "^fix" | sed 's/^fix/- /' >> CHANGELOG_TEMP.md || echo "No bug fixes" >> CHANGELOG_TEMP.md
                  echo "" >> CHANGELOG_TEMP.md

                  cat CHANGELOG_TEMP.md
                  echo "changelog_file=CHANGELOG_TEMP.md" >> $GITHUB_OUTPUT

            - name: Commit version bump
              run: |
                  git add package.json packages/*/package.json package-lock.json
                  git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
                  git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }}"

            - name: Build all packages
              run: npm run build

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Extract version parts
              id: version_parts
              run: |
                  VERSION="${{ steps.version.outputs.new_version }}"
                  MAJOR=$(echo $VERSION | cut -d. -f1)
                  MINOR=$(echo $VERSION | cut -d. -f1-2)
                  echo "major=$MAJOR" >> $GITHUB_OUTPUT
                  echo "minor=$MINOR" >> $GITHUB_OUTPUT
                  echo "full=$VERSION" >> $GITHUB_OUTPUT

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      wifsimster/the-box:latest
                      wifsimster/the-box:v${{ steps.version_parts.outputs.full }}
                      wifsimster/the-box:${{ steps.version_parts.outputs.minor }}
                      wifsimster/the-box:${{ steps.version_parts.outputs.major }}
                  build-args: |
                      VERSION=${{ steps.version.outputs.new_version }}
                      BUILD_DATE=${{ github.event.repository.updated_at }}
                      VCS_REF=${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  platforms: linux/amd64,linux/arm64

            - name: Push changes to repository
              run: |
                  git push origin main
                  git push origin "v${{ steps.version.outputs.new_version }}"

            - name: Create GitHub Release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: v${{ steps.version.outputs.new_version }}
                  release_name: Release v${{ steps.version.outputs.new_version }}
                  body_path: ${{ steps.changelog.outputs.changelog_file }}
                  draft: false
                  prerelease: false

            - name: Notify release
              run: |
                  echo "‚úÖ Released version ${{ steps.version.outputs.new_version }}"
                  echo "üê≥ Docker images published:"
                  echo "   - wifsimster/the-box:latest"
                  echo "   - wifsimster/the-box:v${{ steps.version_parts.outputs.full }}"
                  echo "   - wifsimster/the-box:${{ steps.version_parts.outputs.minor }}"
                  echo "   - wifsimster/the-box:${{ steps.version_parts.outputs.major }}"
