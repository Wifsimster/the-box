# Database Instructions

## ORM: Knex.js

This project uses **Knex.js** (not Drizzle) for database access and migrations.

## Database Schema (12 tables)

- `users` - Player accounts and authentication
- `games` - Game titles metadata
- `screenshots` - Panoramic screenshot references
- `daily_challenges` - Daily game configurations
- `tiers` - Difficulty tiers (1-5) with time limits
- `tier_screenshots` - Screenshots assigned to each tier
- `game_sessions` - Player game attempts
- `tier_sessions` - Per-tier progress tracking
- `guesses` - Individual player guesses
- `power_ups` - Available power-up types
- `bonus_rounds` - Special bonus round configurations
- `leaderboard` - Aggregated player rankings

## Migration Commands

```bash
# Create new migration
npx knex migrate:make migration_name -x ts

# Run migrations
npx knex migrate:latest

# Rollback last migration
npx knex migrate:rollback

# Run seeds
npx knex seed:run
```

## Connection Config

Database connection is configured in `backend/src/config/database.ts` using environment variables:

- `DATABASE_URL` or individual: `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`

## Query Patterns

```typescript
// Use the db export from config/database
import { db } from '@/config/database';

// Select
const users = await db('users').where('active', true);

// Insert with returning
const [user] = await db('users').insert({ ... }).returning('*');

// Transaction
await db.transaction(async (trx) => {
  await trx('users').insert(...);
  await trx('scores').insert(...);
});
```

## Important Notes

- Always use parameterized queries (Knex handles this automatically)
- Use transactions for multi-table operations
- Include proper error handling for constraint violations

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>